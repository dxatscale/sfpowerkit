name: Review-Smoke-Test
on:
  pull_request:
    branches: 
      - main
      - 'hotfix/*'
      
  workflow_dispatch:
      
jobs:
  SmokeTest:
      name: Smoke Test PR
      runs-on: 'ubuntu-latest'     
      
      steps:
        - uses: actions/checkout@v3
        - name: Setup Node.js environment
          uses: actions/setup-node@v3.3.0
          with:
            node-version: '14'
            registry-url: 'https://registry.npmjs.org'
            
        - name: Install SFDX
          run: npm install -g  sfdx-cli
          
        - name: Install sfpowerkit
          run: echo y | sfdx plugins:install sfpowerkit
          
        - name: Store Auth File
          run: echo "${{ secrets.DEVHUB_SFDX_AUTH_URL }}" > ./authfile 
        
        - name: Authenitcate to DevHub
          run: sfdx auth:sfdxurl:store -f authfile -a HubOrg
          
        - name: Scaffold SFDX Project
          run: sfdx force:project:create --projectname testProject --template standard 
          
        - name: Smoke Test Org Commands
          run: | 
              set -euxo pipefail
              sfdx sfpowerkit:org:manifest:build -o manifest.xml -u HubOrg 
              sfdx sfpowerkit:org:manifest:build -o manifest.xml -u HubOrg --json | jq -r .result.result
              sfdx sfpowerkit:org:orgcoverage -u HubOrg
              sfdx sfpowerkit:org:orgcoverage -u HubOrg --json | jq -r .result.classCoverage[0].id
              sfdx sfpowerkit:org:healthcheck -u HubOrg
          
        - name: Smoke Test Profile Commands
          run: |
              set -euxo pipefail
              sfdx sfpowerkit:source:profile:retrieve -u HubOrg
              sfdx sfpowerkit:source:profile:reconcile -u HubOrg
          working-directory: testProject
        
